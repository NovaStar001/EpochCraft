<script>
const pollId = "poll-2";
const pollDurationDays = 2;
const pollStart = new Date("2025-11-08");

let selectedOption = null;

// Load poll data from server
async function loadPollData() {
    const res = await fetch(`/poll-data`);
    return await res.json();
}

// Submit vote to server
async function submitVote(index) {
    const res = await fetch(`/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ optionIndex: index })
    });
    return await res.json();
}

// UI setup
const optionContainer = document.getElementById("options");
const resultsContainer = document.getElementById("results");
const voteBtn = document.getElementById("voteBtn");

function isPollClosed() {
    const now = new Date();
    const diff = (now - pollStart) / (1000 * 60 * 60 * 24);
    return diff >= pollDurationDays;
}

async function init() {
    const pollData = await loadPollData();

    // Build options
    pollData.votes.forEach((opt, i) => {
        const div = document.createElement("div");
        div.className = "poll-option";
        div.textContent = opt.name;
        div.onclick = () => {
            document.querySelectorAll(".poll-option").forEach(e => e.classList.remove("selected"));
            div.classList.add("selected");
            selectedOption = i;
        };
        optionContainer.appendChild(div);
    });

    if (pollData.userVoted || isPollClosed()) {
        showResults(pollData);
    }

    voteBtn.onclick = async () => {
        if (isPollClosed()) return alert("Poll closed!");
        if (pollData.userVoted) return alert("You already voted!");
        if (selectedOption === null) return alert("Please select an option!");

        const result = await submitVote(selectedOption);
        showResults(result);
    };
}

function showResults(pollData) {
    optionContainer.style.display = "none";
    voteBtn.style.display = "none";
    resultsContainer.innerHTML = "";

    const totalVotes = pollData.votes.reduce((s, o) => s + o.votes, 0);
    const winner = pollData.votes.reduce((a, b) => a.votes > b.votes ? a : b);

    pollData.votes.forEach(opt => {
        const percent = totalVotes ? Math.round((opt.votes / totalVotes) * 100) : 0;
        const div = document.createElement("div");
        div.innerHTML = `
            <strong>${opt.name}</strong> - ${percent}% (${opt.votes} votes)
            <div class="result-bar" style="width:${percent}%;"></div>
        `;
        resultsContainer.appendChild(div);
    });

    if (isPollClosed()) {
        const closedMsg = document.createElement("div");
        closedMsg.innerHTML = `<h3>Poll Closed!</h3><p>Winning option: <strong>${winner.name}</strong> (${winner.votes} votes)</p>`;
        resultsContainer.appendChild(closedMsg);
    }
}

init();
</script>
